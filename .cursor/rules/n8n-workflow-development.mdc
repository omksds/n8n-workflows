---
globs: *.json
description: n8n ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é–‹ç™ºã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
---

# n8n ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é–‹ç™ºãƒ«ãƒ¼ãƒ«

## ğŸš¨ é‡è¦: Switch ãƒãƒ¼ãƒ‰ã§ã®æ¡ä»¶åˆ†å²

### âŒ é¿ã‘ã‚‹ã¹ããƒ‘ã‚¿ãƒ¼ãƒ³

```json
// æ•°å€¤ã®ç›´æ¥æ¯”è¼ƒã¯å‹ã‚¨ãƒ©ãƒ¼ã®åŸå› 
{
  "leftValue": "={{ $json.image_analysis.aspectRatio }}",
  "rightValue": 0.67,
  "operator": {
    "type": "number",
    "operation": "smaller"
  }
}
```

### âœ… æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³

```json
// ãƒ–ãƒ¼ãƒ«å€¤ã§ã®æ¯”è¼ƒã‚’ä½¿ç”¨
{
  "leftValue": "={{ $json.image_analysis.is_tall }}",
  "rightValue": "",
  "operator": {
    "type": "boolean",
    "operation": "true",
    "singleValue": true
  }
}
```

## ğŸ“‹ Switch ãƒãƒ¼ãƒ‰è¨­å®šã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### å¿…é ˆè¨­å®š

- `"typeValidation": "loose"` - å³å¯†ãªå‹ãƒã‚§ãƒƒã‚¯ã‚’ç·©å’Œ
- `"looseTypeValidation": true` - å‹å¤‰æ›ã‚’è¨±å¯
- `"singleValue": true` - ãƒ–ãƒ¼ãƒ«å€¤æ¯”è¼ƒæ™‚ã¯å¿…é ˆ

### Code ãƒãƒ¼ãƒ‰ã§ã®äº‹å‰å‡¦ç†

```python
# Switch ãƒãƒ¼ãƒ‰ç”¨ã«ãƒ–ãƒ¼ãƒ«å€¤ã‚’äº‹å‰è¨ˆç®—
image_data = {
    'aspectRatio': float(aspect_ratio),
    'is_tall': bool(aspect_ratio < 0.67),  # Switchç”¨ãƒ–ãƒ¼ãƒ«å€¤
    'classification': 'tall' if aspect_ratio < 0.67 else 'not_tall'
}
```

## ğŸ”§ Python Code ãƒãƒ¼ãƒ‰ã§ã®å‹å®‰å…¨æ€§

### å¿…é ˆã®å‹å¤‰æ›

```python
# æ˜ç¤ºçš„ãªå‹å¤‰æ›ã§ n8n ã¨ã®æ•´åˆæ€§ã‚’ä¿è¨¼
image_data = {
    'width': int(width),
    'height': int(height),
    'aspectRatio': float(aspect_ratio),
    'is_tall': bool(aspect_ratio < threshold),
    'classification': str(classification)
}
```

### ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºå‡¦ç†

```python
def parse_file_size(size_str):
    """n8n ã® S3 ãƒãƒ¼ãƒ‰ã‹ã‚‰è¿”ã•ã‚Œã‚‹ '1.06 MB' å½¢å¼ã‚’æ•°å€¤ã«å¤‰æ›"""
    if isinstance(size_str, (int, float)):
        return int(size_str)

    if not isinstance(size_str, str):
        return 0

    size_match = re.search(r'([\d.]+)\s*(MB|KB|B)', size_str, re.IGNORECASE)
    if size_match:
        size_value = float(size_match.group(1))
        size_unit = size_match.group(2).upper()
        if size_unit == 'MB':
            return int(size_value * 1024 * 1024)
        elif size_unit == 'KB':
            return int(size_value * 1024)
        else:
            return int(size_value)

    try:
        return int(float(size_str))
    except (ValueError, TypeError):
        return 0
```

## ğŸ›¡ï¸ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®ä¿è¨¼

```python
# ã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚ Switch ãƒãƒ¼ãƒ‰ãŒå‡¦ç†ã§ãã‚‹å½¢å¼ã‚’ç¶­æŒ
if error_occurred:
    image_data = {
        'aspectRatio': 1.33,  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        'is_tall': False,     # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ¼ãƒ«å€¤
        'classification': 'error'
    }
```

### ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹

```python
# n8n ã® Code ãƒãƒ¼ãƒ‰ï¼ˆrunOnceForEachItem ãƒ¢ãƒ¼ãƒ‰ï¼‰ã§ã®ãƒã‚¤ãƒŠãƒªã‚¢ã‚¯ã‚»ã‚¹
if _binary and 'image_data' in _binary:
    binary_data = _binary['image_data']  # æ­£ã—ã„ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•
    file_size = parse_file_size(binary_data.get('fileSize', 0))
```

## ğŸ“Š ãƒ‡ãƒãƒƒã‚°ã¨ãƒ­ã‚°

### è©³ç´°ãªãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°

```python
print(f"[DEBUG] - AspectRatio: {aspect_ratio} (type: {type(aspect_ratio)})")
print(f"[DEBUG] - is_tall: {is_tall} (type: {type(is_tall)})")
print(f"[DEBUG] - Threshold comparison: {aspect_ratio} < {threshold} = {aspect_ratio < threshold}")
```

## ğŸ”„ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ§‹é€ 

### æ¨å¥¨ãƒãƒ¼ãƒ‰é †åº

1. **Webhook/Manual Trigger** - å…¥åŠ›å—ä»˜
2. **Set ãƒãƒ¼ãƒ‰** - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æº–å‚™ãƒ»æ¤œè¨¼
3. **If ãƒãƒ¼ãƒ‰** - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¤œè¨¼
4. **S3 ãƒãƒ¼ãƒ‰** - ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿å–å¾—
5. **Code ãƒãƒ¼ãƒ‰ (Python)** - åˆ†æãƒ»è¨ˆç®—ï¼ˆãƒ–ãƒ¼ãƒ«å€¤å‡ºåŠ›ï¼‰
6. **Switch ãƒãƒ¼ãƒ‰** - ãƒ–ãƒ¼ãƒ«å€¤ã§ã®æ¡ä»¶åˆ†å²
7. **Code ãƒãƒ¼ãƒ‰ (Python)** - æœ€çµ‚å‡¦ç†

### é‡è¦ãªæ¥ç¶šãƒ‘ã‚¿ãƒ¼ãƒ³

- **S3 â†’ Code**: `binaryPropertyName: "image_data"`
- **Code â†’ Switch**: `is_tall` ãƒ–ãƒ¼ãƒ«å€¤ã‚’ä½¿ç”¨
- **Switch â†’ å¾Œç¶š**: é©åˆ‡ãªå‡ºåŠ›ã‚­ãƒ¼ã§åˆ†å²
