{
  "name": "Enhanced Slack Image to S3 Upload Workflow",
  "nodes": [
    {
      "parameters": {
        "trigger": ["app_mention"],
        "channelId": {
          "__rl": true,
          "value": "C0790JJ923E",
          "mode": "list",
          "cachedResultName": "å›å¸°pj_program"
        },
        "options": {}
      },
      "id": "slack-trigger-001",
      "name": "Slack Trigger",
      "type": "n8n-nodes-base.slackTrigger",
      "typeVersion": 1,
      "position": [40, 100],
      "webhookId": "enhanced-slack-webhook",
      "credentials": {
        "slackApi": {
          "id": "rtOAhzxGADr1mh6l",
          "name": "enterral"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "image-check",
              "leftValue": "={{ $json.files && $json.files.length > 0 ? $json.files[0].mimetype : '' }}",
              "rightValue": "image/",
              "operator": {
                "type": "string",
                "operation": "startsWith"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-image-001",
      "name": "Check if Image",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [280, 100]
    },
    {
      "parameters": {
        "url": "={{ $json.files[0].url_private }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "slackApi",
        "options": {}
      },
      "id": "download-image-001",
      "name": "Download Image from Slack",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [520, 100],
      "credentials": {
        "slackApi": {
          "id": "rtOAhzxGADr1mh6l",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”åˆ†æç”¨Pythonã‚³ãƒ¼ãƒ‰\nconst items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  try {\n    // ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ç¢ºèª\n    if (!item.binary || !item.binary.data) {\n      results.push({\n        json: {\n          ...item.json,\n          image_analysis: {\n            error: 'No binary data found',\n            aspectRatio: 0,\n            is_tall: false,\n            classification: 'error'\n          }\n        },\n        binary: item.binary\n      });\n      continue;\n    }\n    \n    // ç”»åƒã‚µã‚¤ã‚ºã®å–å¾—\n    const imageData = item.binary.data;\n    const width = imageData.width || 0;\n    const height = imageData.height || 0;\n    \n    if (width === 0 || height === 0) {\n      results.push({\n        json: {\n          ...item.json,\n          image_analysis: {\n            error: 'Invalid image dimensions',\n            aspectRatio: 0,\n            is_tall: false,\n            classification: 'error'\n          }\n        },\n        binary: item.binary\n      });\n      continue;\n    }\n    \n    // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã®è¨ˆç®—\n    const aspectRatio = width / height;\n    const isTall = aspectRatio < 0.67; // 2:3ã®é–¾å€¤\n    \n    // åˆ†é¡ã®æ±ºå®š\n    let classification = 'wide';\n    if (isTall) {\n      classification = 'tall';\n    }\n    \n    results.push({\n      json: {\n        ...item.json,\n        image_analysis: {\n          width: width,\n          height: height,\n          aspectRatio: aspectRatio,\n          is_tall: isTall,\n          classification: classification,\n          error: null\n        }\n      },\n      binary: item.binary\n    });\n    \n  } catch (error) {\n    results.push({\n      json: {\n        ...item.json,\n        image_analysis: {\n          error: error.message,\n          aspectRatio: 0,\n          is_tall: false,\n          classification: 'error'\n        }\n      },\n      binary: item.binary\n    });\n  }\n}\n\nreturn results;"
      },
      "id": "aspect-ratio-analysis-001",
      "name": "Aspect Ratio Analysis",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [760, 100]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "looseTypeValidation": true
          },
          "conditions": [
            {
              "id": "tall-check",
              "leftValue": "={{ $json.image_analysis.is_tall }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "aspect-ratio-check-001",
      "name": "Aspect Ratio Check",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1000, 100]
    },
    {
      "parameters": {
        "operation": "upload",
        "bucketName": "tokushima-return",
        "fileName": "={{ 'r7/BroadCast/' + $json.files[0].name || 'slack_image_' + Date.now() + '.jpg' }}",
        "additionalFields": {
          "serverSideEncryption": "AES256"
        }
      },
      "id": "upload-s3-tall-001",
      "name": "Upload to S3 (ç¸¦é•·)",
      "type": "n8n-nodes-base.awsS3",
      "typeVersion": 2,
      "position": [1240, 60],
      "credentials": {
        "aws": {
          "id": "KX5pZiVVuzNTekoJ",
          "name": "AWS account"
        }
      }
    },
    {
      "parameters": {
        "operation": "upload",
        "bucketName": "tokushima-return",
        "fileName": "={{ 'r7/BroadCast/original_' + $json.files[0].name || 'original_slack_image_' + Date.now() + '.jpg' }}",
        "additionalFields": {
          "serverSideEncryption": "AES256"
        }
      },
      "id": "upload-s3-original-001",
      "name": "Upload Original to S3",
      "type": "n8n-nodes-base.awsS3",
      "typeVersion": 2,
      "position": [1240, 180],
      "credentials": {
        "aws": {
          "id": "KX5pZiVVuzNTekoJ",
          "name": "AWS account"
        }
      }
    },
    {
      "parameters": {
        "operation": "invoke",
        "function": "TokushimaReturn_edit_img",
        "qualifier": "$LATEST",
        "invocationType": "RequestResponse",
        "payload": "={{ JSON.stringify({\n  file_key: 'r7/BroadCast/original_' + ($json.files[0].name || 'slack_image_' + Date.now() + '.jpg'),\n  bucket_name: 'tokushima-return'\n}) }}"
      },
      "id": "lambda-invoke-001",
      "name": "Lambda Invoke",
      "type": "n8n-nodes-base.awsLambda",
      "typeVersion": 1,
      "position": [1480, 180],
      "credentials": {
        "aws": {
          "id": "KX5pZiVVuzNTekoJ",
          "name": "AWS account"
        }
      }
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": "C0790JJ923E",
        "text": "âœ… **ç¸¦é•·ç”»åƒã‚’S3ã«ä¿å­˜ã—ã¾ã—ãŸ**\n\n**ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±:**\nâ€¢ ãƒ•ã‚¡ã‚¤ãƒ«å: {{ $json.files[0].name }}\nâ€¢ ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”: {{ $json.image_analysis.aspectRatio.toFixed(3) }}\nâ€¢ ã‚µã‚¤ã‚º: {{ $json.image_analysis.width }}x{{ $json.image_analysis.height }}\nâ€¢ S3ãƒ‘ã‚¹: {{ $json.fileName }}\n\n**å‡¦ç†çµæœ:** ç¸¦é•·ç”»åƒã®ãŸã‚ã€ãã®ã¾ã¾S3ã«ä¿å­˜ã—ã¾ã—ãŸã€‚",
        "otherOptions": {
          "threadTs": "={{ $json.thread_ts || $json.ts }}"
        }
      },
      "id": "success-message-tall-001",
      "name": "Send Success Message (ç¸¦é•·)",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 1,
      "position": [1480, 60],
      "credentials": {
        "slackApi": {
          "id": "rtOAhzxGADr1mh6l",
          "name": "enterral"
        }
      }
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": "C0790JJ923E",
        "text": "âœ… **æ¨ªé•·ç”»åƒã‚’å‡¦ç†ã—ã¦S3ã«ä¿å­˜ã—ã¾ã—ãŸ**\n\n**ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±:**\nâ€¢ å…ƒãƒ•ã‚¡ã‚¤ãƒ«å: {{ $json.files[0].name }}\nâ€¢ ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”: {{ $json.image_analysis.aspectRatio.toFixed(3) }}\nâ€¢ ã‚µã‚¤ã‚º: {{ $json.image_analysis.width }}x{{ $json.image_analysis.height }}\n\n**ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:**\nâ€¢ å…ƒç”»åƒ: {{ $json.fileName }}\nâ€¢ å‡¦ç†æ¸ˆã¿ç”»åƒ: Lambdaé–¢æ•°å†…ã§S3ã«ä¿å­˜æ¸ˆã¿\n\n**å‡¦ç†çµæœ:** æ¨ªé•·ç”»åƒã®ãŸã‚ã€å…ƒç”»åƒä¿å­˜å¾Œã«Lambdaé–¢æ•°ã§å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚",
        "otherOptions": {
          "threadTs": "={{ $json.thread_ts || $json.ts }}"
        }
      },
      "id": "success-message-wide-001",
      "name": "Send Success Message (æ¨ªé•·)",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 1,
      "position": [1720, 180],
      "credentials": {
        "slackApi": {
          "id": "rtOAhzxGADr1mh6l",
          "name": "enterral"
        }
      }
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": "C0790JJ923E",
        "text": "ğŸš¨ **ç”»åƒå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ**\n\n**ã‚¨ãƒ©ãƒ¼è©³ç´°:**\n{{ $json.image_analysis.error }}\n\n**ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±:**\nâ€¢ ãƒ•ã‚¡ã‚¤ãƒ«å: {{ $json.files[0].name }}\nâ€¢ ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”: {{ $json.image_analysis.aspectRatio }}\n\n**å¯¾å¿œ:** ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚",
        "otherOptions": {
          "threadTs": "={{ $json.thread_ts || $json.ts }}"
        }
      },
      "id": "error-message-001",
      "name": "Send Error Message",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 1,
      "position": [1240, 300],
      "credentials": {
        "slackApi": {
          "id": "rtOAhzxGADr1mh6l",
          "name": "enterral"
        }
      }
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": "C0790JJ923E",
        "text": "âŒ **ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ**\n\n**ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹:**\n{{ $json.text }}\n\n**å¯¾å¿œ:** ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜ã—ã¦ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã—ã¦ãã ã•ã„ã€‚",
        "otherOptions": {
          "threadTs": "={{ $json.thread_ts || $json.ts }}"
        }
      },
      "id": "debug-message-001",
      "name": "Send Debug Message",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 1,
      "position": [520, 220],
      "credentials": {
        "slackApi": {
          "id": "rtOAhzxGADr1mh6l",
          "name": "enterral"
        }
      }
    }
  ],
  "connections": {
    "Slack Trigger": {
      "main": [
        [
          {
            "node": "Check if Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Image": {
      "main": [
        [
          {
            "node": "Download Image from Slack",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Debug Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Image from Slack": {
      "main": [
        [
          {
            "node": "Aspect Ratio Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aspect Ratio Analysis": {
      "main": [
        [
          {
            "node": "Aspect Ratio Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aspect Ratio Check": {
      "main": [
        [
          {
            "node": "Upload to S3 (ç¸¦é•·)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Upload Original to S3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Error Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload to S3 (ç¸¦é•·)": {
      "main": [
        [
          {
            "node": "Send Success Message (ç¸¦é•·)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload Original to S3": {
      "main": [
        [
          {
            "node": "Lambda Invoke",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lambda Invoke": {
      "main": [
        [
          {
            "node": "Send Success Message (æ¨ªé•·)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-01-15T10:00:00.000Z",
      "updatedAt": "2025-01-15T10:00:00.000Z",
      "id": "enhanced-slack-workflow",
      "name": "Enhanced Slack Workflow"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-01-15T10:00:00.000Z",
  "versionId": "1"
} 